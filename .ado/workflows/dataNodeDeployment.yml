name: Data Node Deployment

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'infra/Storage/**'
      - 'infra/KeyVault/**'
      - 'infra/PrivateEndpoint/**'
      - '.ado/workflows/dataNodeDeployment.yml'

variables:
  AZURE_RESOURCE_MANAGER_CONNECTION_NAME: 'Marvins Azure Subscription(558bd446-4212-46a2-908c-9ab0a628705e)'
  AZURE_SUBSCRIPTION_ID: '558bd446-4212-46a2-908c-9ab0a628705e'
  AZURE_RESOURCE_GROUP_NAME: 'datanode001-storage'
  AZURE_LOCATION: 'North Europe'

stages:
  - stage: Validation
    displayName: 'Validation of ARM templates'
    jobs:
      - job: Validation
        displayName: 'Validation of ARM templates'
        continueOnError: false
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
        # Checkout code
        - checkout: self
          name: checkout_repository
          displayName: 'Checkout repository'
          submodules: true
          lfs: false
          clean: true
          continueOnError: false
          enabled: true
        
        # # Deploy key vault 001 - validation
        # - task: AzureResourceManagerTemplateDeployment@3
        #   name: key_vault_001_validation
        #   displayName: Deploy key vault 001 - validation
        #   enabled: true
        #   continueOnError: false
        #   inputs:
        #     deploymentScope: 'Resource Group'
        #     azureResourceManagerConnection: '$(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)'
        #     subscriptionId: '$(AZURE_SUBSCRIPTION_ID)'
        #     action: 'Create Or Update Resource Group'
        #     resourceGroupName: '$(AZURE_RESOURCE_GROUP_NAME)'
        #     location: '$(AZURE_LOCATION)'
        #     templateLocation: 'Linked artifact'
        #     csmFile: 'infra/KeyVault/deploy.keyVault.json'
        #     csmParametersFile: 'infra/KeyVault/params.keyVault001.json'
        #     deploymentMode: 'Validation'
        
        # Deploy storage account - raw - validation
        - task: AzureResourceManagerTemplateDeployment@3
          name: storage_account_raw_validation
          displayName: Deploy storage account - raw - validation
          enabled: true
          continueOnError: false
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: '$(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)'
            subscriptionId: '$(AZURE_SUBSCRIPTION_ID)'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(AZURE_RESOURCE_GROUP_NAME)'
            location: '$(AZURE_LOCATION)'
            templateLocation: 'Linked artifact'
            csmFile: 'infra/Storage/deploy.storage.json'
            csmParametersFile: 'infra/Storage/params.storage001.json'
            deploymentMode: 'Validation'
        
        # Deploy storage account - curated - validation
        - task: AzureResourceManagerTemplateDeployment@3
          name: storage_account_curated_validation
          displayName: Deploy storage account - curated - validation
          enabled: true
          continueOnError: false
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: '$(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)'
            subscriptionId: '$(AZURE_SUBSCRIPTION_ID)'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(AZURE_RESOURCE_GROUP_NAME)'
            location: '$(AZURE_LOCATION)'
            templateLocation: 'Linked artifact'
            csmFile: 'infra/Storage/deploy.storage.json'
            csmParametersFile: 'infra/Storage/params.storage002.json'
            deploymentMode: 'Validation'
        
        # Deploy storage account - workspace - validation
        - task: AzureResourceManagerTemplateDeployment@3
          name: storage_account_workspace_validation
          displayName: Deploy storage account - workspace - validation
          enabled: true
          continueOnError: false
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: '$(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)'
            subscriptionId: '$(AZURE_SUBSCRIPTION_ID)'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(AZURE_RESOURCE_GROUP_NAME)'
            location: '$(AZURE_LOCATION)'
            templateLocation: 'Linked artifact'
            csmFile: 'infra/Storage/deploy.storage.json'
            csmParametersFile: 'infra/Storage/params.storage003.json'
            deploymentMode: 'Validation'

  - stage: Deployment
    displayName: 'Deployment of ARM templates'
    dependsOn: Validation
    condition: succeeded()
    jobs:
      - job: Deployment
        displayName: 'Deployment of ARM templates'
        continueOnError: false
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
        # Checkout repository
        - checkout: self
          name: checkout_repository
          displayName: 'Checkout repository'
          submodules: true
          lfs: false
          clean: true
          continueOnError: false
          enabled: true
        
        # # Deploy key vault 001
        # - task: AzureResourceManagerTemplateDeployment@3
        #   name: key_vault_001_deployment
        #   displayName: Deploy key vault 001
        #   enabled: true
        #   continueOnError: false
        #   inputs:
        #     deploymentScope: 'Resource Group'
        #     azureResourceManagerConnection: '$(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)'
        #     subscriptionId: '$(AZURE_SUBSCRIPTION_ID)'
        #     action: 'Create Or Update Resource Group'
        #     resourceGroupName: '$(AZURE_RESOURCE_GROUP_NAME)'
        #     location: '$(AZURE_LOCATION)'
        #     templateLocation: 'Linked artifact'
        #     csmFile: 'infra/KeyVault/deploy.keyVault.json'
        #     csmParametersFile: 'infra/KeyVault/params.keyVault001.json'
        #     deploymentMode: 'Incremental'

        # Deploy storage account - raw
        - task: AzureResourceManagerTemplateDeployment@3
          name: storage_account_raw_deployment
          displayName: Deploy storage account - raw
          enabled: true
          continueOnError: false
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: '$(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)'
            subscriptionId: '$(AZURE_SUBSCRIPTION_ID)'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(AZURE_RESOURCE_GROUP_NAME)'
            location: '$(AZURE_LOCATION)'
            templateLocation: 'Linked artifact'
            csmFile: 'infra/Storage/deploy.storage.json'
            csmParametersFile: 'infra/Storage/params.storage001.json'
            deploymentMode: 'Incremental'
        
        # Deploy storage account - curated
        - task: AzureResourceManagerTemplateDeployment@3
          name: storage_account_curated_deployment
          displayName: Deploy storage account - curated
          enabled: true
          continueOnError: false
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: '$(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)'
            subscriptionId: '$(AZURE_SUBSCRIPTION_ID)'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(AZURE_RESOURCE_GROUP_NAME)'
            location: '$(AZURE_LOCATION)'
            templateLocation: 'Linked artifact'
            csmFile: 'infra/Storage/deploy.storage.json'
            csmParametersFile: 'infra/Storage/params.storage002.json'
            deploymentMode: 'Incremental'
        
        # Deploy storage account - workspace
        - task: AzureResourceManagerTemplateDeployment@3
          name: storage_account_workspace_deployment
          displayName: Deploy storage account - workspace
          enabled: true
          continueOnError: false
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: '$(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)'
            subscriptionId: '$(AZURE_SUBSCRIPTION_ID)'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(AZURE_RESOURCE_GROUP_NAME)'
            location: '$(AZURE_LOCATION)'
            templateLocation: 'Linked artifact'
            csmFile: 'infra/Storage/deploy.storage.json'
            csmParametersFile: 'infra/Storage/params.storage003.json'
            deploymentMode: 'Incremental'
